{% extends 'layout.html' %}

{% block title %}Dashboard{% endblock %}

{% block body %}
  <div class="container">
    <h1>Dashboard</h1>

    <!-- CSS to define CO2 level colors -->
    <style>
      .co2-box {
        display: inline-block;
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        font-weight: bold;
        color: #fff;
        margin-left: 10px;
      }
      .co2-low { background-color: #28a745; } /* Green */
      .co2-medium { background-color: #ffc107; color: #000; } /* Yellow */
      .co2-high { background-color: #fd7e14; } /* Orange */
      .co2-critical { background-color: #dc3545; } /* Red */
    </style>

    <!-- Assign Fan Section -->
    <h2>Assign Fan</h2>
    <form method="post">
      <div class="form-group">
        <label for="room">Room</label>
        <select class="form-control" id="room" name="room">
          {% for room in rooms %}
            <option value="{{ room['roomGroupName'] }}">{{ room['roomGroupName'] }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary" name="assign_fan">Assign Fan</button>
    </form>

    <!-- Fan Assignments Section -->
    <h2 class="mt-4">Fan Assignments</h2>
    <ul class="list-group mt-3">
      {% for fan in fan_assignments %}
        <li class="list-group-item">
          <p>
            <strong>Room:</strong> 
            <a href="{{ url_for('room_graph', room=fan['room']) }}">{{ fan['room'] }}</a>
          </p>
          <p>
            <strong>CO₂ Level:</strong>
            {% if fan['co2_level'] < 1000 %}
              {% set co2_class = 'co2-low' %}
            {% elif fan['co2_level'] < 1500 %}
              {% set co2_class = 'co2-medium' %}
            {% elif fan['co2_level'] < 2000 %}
              {% set co2_class = 'co2-high' %}
            {% else %}
              {% set co2_class = 'co2-critical' %}
            {% endif %}
            
            <!-- Added an ID to each CO₂ element -->
            <span id="co2-{{ fan['room'] }}" class="co2-box {{ co2_class }}">
              {{ fan['co2_level'] }} ppm
            </span>
          </p>
          {% if fan.get('message') %}
            <p><strong>Message:</strong> {{ fan['message'] }}</p>
          {% endif %}
          <form action="{{ url_for('dashboard') }}" method="post" class="mt-2">
            <input type="hidden" name="room" value="{{ fan['room'] }}">
            <button type="submit" name="fan_control" value="on" class="btn btn-success">Turn On</button>
            <button type="submit" name="fan_control" value="off" class="btn btn-danger">Turn Off</button>
            <button type="submit" name="remove_fan" class="btn btn-warning">Remove Fan</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- JavaScript for Dynamic CO₂ Level Updates -->
  <script>
    // Function to fetch updated CO2 levels
    function updateCO2Levels() {
      fetch("{{ url_for('get_co2_levels') }}") // Calls new API endpoint
        .then(response => response.json())
        .then(data => {
          data.forEach(room => {
            let co2Element = document.getElementById(`co2-${room.roomGroupName}`);
            if (co2Element) {
              co2Element.innerText = room.co2 + " ppm";
              
              // Update background color based on CO2 level
              if (room.co2 < 1000) {
                co2Element.className = "co2-box co2-low";
              } else if (room.co2 < 1500) {
                co2Element.className = "co2-box co2-medium";
              } else if (room.co2 < 2000) {
                co2Element.className = "co2-box co2-high";
              } else {
                co2Element.className = "co2-box co2-critical";
              }
            }
          });
        })
        .catch(error => console.error("Error fetching CO2 levels:", error));
    }

    // Auto-refresh CO2 levels every 10 seconds
    setInterval(updateCO2Levels, 10000);

    // Fetch data immediately when the page loads
    updateCO2Levels();
  </script>

{% endblock %}
